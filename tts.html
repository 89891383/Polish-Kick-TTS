<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polish Kick TTS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0e6ed;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        h1 {
            font-size: 2.5em;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
        }

        .subtitle {
            font-size: 1em;
            font-weight: 300;
            color: #9ca3af;
            margin-top: 8px;
        }

        .section {
            background: rgba(255, 255, 255, 0.03);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        h2 {
            color: #ffffff;
            font-size: 1.5em;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h3 {
            color: #d1d5db;
            font-size: 1.1em;
            margin: 20px 0 12px 0;
            font-weight: 500;
        }

        .generator {
            background: rgba(255, 255, 255, 0.05);
            padding: 35px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 400;
            color: #d1d5db;
            font-size: 0.95em;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #ffffff;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95em;
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: rgba(96, 165, 250, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .checkbox-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item:hover {
            border-color: rgba(96, 165, 250, 0.4);
            background: rgba(255, 255, 255, 0.06);
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #60a5fa;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            color: #e0e6ed;
            font-size: 0.9em;
        }

        .checkbox-item.checked {
            border-color: rgba(96, 165, 250, 0.5);
            background: rgba(96, 165, 250, 0.08);
        }

        button {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(96, 165, 250, 0.3);
        }

        .result {
            background: rgba(96, 165, 250, 0.08);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            display: none;
        }

        .result.show {
            display: block;
        }

        .url-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 14px;
            border-radius: 6px;
            word-break: break-all;
            color: #60a5fa;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 12px 0;
        }

        .copy-btn {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            margin-top: 10px;
        }

        .copy-btn:hover {
            box-shadow: 0 4px 16px rgba(52, 211, 153, 0.3);
        }

        code {
            background: rgba(255, 255, 255, 0.08);
            padding: 3px 8px;
            border-radius: 4px;
            color: #60a5fa;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .voice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .voice-card {
            background: rgba(255, 255, 255, 0.04);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            text-align: center;
            transition: all 0.2s ease;
        }

        .voice-card:hover {
            border-color: rgba(96, 165, 250, 0.4);
            transform: translateY(-2px);
        }

        .voice-name {
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .voice-type {
            font-size: 0.85em;
            color: #9ca3af;
        }

        ul {
            list-style: none;
            padding-left: 0;
        }

        ul li {
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
            color: #d1d5db;
            font-size: 0.95em;
        }

        ul li:before {
            content: "•";
            color: #60a5fa;
            position: absolute;
            left: 0;
            font-weight: bold;
            font-size: 1.2em;
        }

        .info-box {
            background: rgba(96, 165, 250, 0.08);
            border-left: 3px solid #60a5fa;
            padding: 12px 16px;
            margin: 12px 0;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .info-box strong {
            color: #60a5fa;
        }

        svg {
            width: 32px;
            height: 32px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .container {
                padding: 20px 15px;
            }

            .section, .generator {
                padding: 20px;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="readme">
        <header>
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C10.9 2 10 2.9 10 4V12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12V4C14 2.9 13.1 2 12 2Z" fill="#60a5fa"/>
                    <path d="M19 10C19 6.1 15.9 3 12 3C8.1 3 5 6.1 5 10H7C7 7.2 9.2 5 12 5C14.8 5 17 7.2 17 10H19Z" fill="#60a5fa" opacity="0.6"/>
                    <path d="M12 16C8.1 16 5 12.9 5 9H7C7 11.8 9.2 14 12 14C14.8 14 17 11.8 17 9H19C19 12.9 15.9 16 12 16Z" fill="#60a5fa" opacity="0.6"/>
                    <path d="M11 16H13V22H11V16Z" fill="#60a5fa"/>
                    <path d="M8 22H16V20H8V22Z" fill="#60a5fa"/>
                </svg>
                <h1>Polish Kick TTS</h1>
            </div>
            <p class="subtitle">System Text-to-Speech dla streamów Kick.com</p>
        </header>

        <div class="generator">
            <h2>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.7 19L13.6 9.9C14.5 7.6 14 4.9 12.1 3C9.6 0.5 5.6 0.5 3.1 3C0.6 5.5 0.6 9.5 3.1 12C5 13.9 7.7 14.4 10 13.5L13 16.5V19H15V17L17 19L15 21L16.4 22.4L18 20.8L19.6 22.4L21 21L19.4 19.4L21 17.8L19.6 16.4L17.6 18.4L19.7 19ZM5.2 10.9C3.5 9.2 3.5 6.6 5.2 4.9C6.9 3.2 9.5 3.2 11.2 4.9C12.9 6.6 12.9 9.2 11.2 10.9C9.5 12.6 6.9 12.6 5.2 10.9Z" fill="#60a5fa"/>
                </svg>
                Generator Linku TTS
            </h2>
            
            <div class="form-group">
                <label for="channel">Nazwa Kanału (wymagane)</label>
                <input type="text" id="channel" placeholder="np. anon_x64" required>
            </div>

            <div class="form-group">
                <label for="voice">Głos</label>
                <select id="voice">
                    <option value="Zosia">Zosia (Kobieta - Domyślny)</option>
                    <option value="Agatka">Agatka (Kobieta)</option>
                    <option value="Danota">Danota (Kobieta)</option>
                    <option value="Krzysztof">Krzysztof (Mężczyzna)</option>
                    <option value="Wojciech">Wojciech (Mężczyzna)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="volume">Głośność (0-100)</label>
                <input type="number" id="volume" min="0" max="100" value="50">
            </div>

            <div class="form-group">
                <label>Uprawnienia</label>
                <div class="info-box">
                    <strong>Uwaga:</strong> Broadcaster ma zawsze dostęp niezależnie od ustawień
                </div>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="anyone" onchange="toggleCheckbox(this)">
                        <label for="anyone">Każdy</label>
                    </div>
                    <div class="checkbox-item checked">
                        <input type="checkbox" id="follower" checked onchange="toggleCheckbox(this)">
                        <label for="follower">Obserwujący</label>
                    </div>
                    <div class="checkbox-item checked">
                        <input type="checkbox" id="moderator" checked onchange="toggleCheckbox(this)">
                        <label for="moderator">Moderator</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="og" onchange="toggleCheckbox(this)">
                        <label for="og">OG</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="subscriber" onchange="toggleCheckbox(this)">
                        <label for="subscriber">Subskrybent</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="vip" onchange="toggleCheckbox(this)">
                        <label for="vip">VIP</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Format Wiadomości</label>
                <div class="checkbox-item">
                    <input type="checkbox" id="pretext" onchange="toggleCheckbox(this)">
                    <label for="pretext">Wymagaj "tts" przed wiadomością</label>
                </div>
            </div>

            <button onclick="generateURL()">Wygeneruj Link TTS</button>
            
            <div class="result" id="result">
                <h3>Twój Link TTS:</h3>
                <div class="url-display" id="url-display"></div>
                <button class="copy-btn" onclick="copyURL()">Skopiuj Link</button>
            </div>
        </div>

        <div class="section">
            <h2>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19Z" fill="#60a5fa"/>
                    <path d="M7 17H9V10H7V17ZM11 17H13V7H11V17ZM15 17H17V13H15V17Z" fill="#60a5fa"/>
                </svg>
                Co to jest?
            </h2>
            <p>Polish Kick TTS to darmowy system Text-to-Speech dla streamerów Kick.com. Gdy użytkownicy wysyłają wiadomości na czacie, będą one automatycznie czytane na głos przy użyciu polskiej syntezy mowy.</p>
        </div>

        <div class="section">
            <h2>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7V17C2 17 2 22 12 22C22 22 22 17 22 17V7L12 2Z" stroke="#60a5fa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    <path d="M12 11C13.66 11 15 9.66 15 8C15 6.34 13.66 5 12 5C10.34 5 9 6.34 9 8C9 9.66 10.34 11 12 11Z" fill="#60a5fa"/>
                    <path d="M12 11C9 11 6 12.79 6 15V17H18V15C18 12.79 15 11 12 11Z" fill="#60a5fa" opacity="0.6"/>
                </svg>
                Funkcje
            </h2>
            <ul>
                <li>5 polskich głosów (męskich i żeńskich)</li>
                <li>Szczegółowa kontrola uprawnień (Każdy, Obserwujący, Moderator, OG, Subskrybent, VIP)</li>
                <li>Opcjonalne wymaganie przedrostka "tts"</li>
                <li>Kontrola głośności 0-100</li>
                <li>Automatyczne filtrowanie wiadomości botów</li>
                <li>Zamiana linków na słowo "LINK"</li>
                <li>Kolejkowanie wiadomości</li>
            </ul>
        </div>

        <div class="section">
            <h2>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="3" fill="#60a5fa"/>
                    <path d="M19.4 15C19.5 14.7 19.5 14.3 19.4 14L21.5 12.3C21.7 12.1 21.7 11.8 21.6 11.6L19.6 8.4C19.5 8.2 19.2 8.1 19 8.2L16.6 9.2C16.1 8.8 15.6 8.5 15 8.3L14.6 5.7C14.6 5.5 14.4 5.3 14.2 5.3H10.2C10 5.3 9.8 5.5 9.8 5.7L9.4 8.3C8.8 8.5 8.3 8.8 7.8 9.2L5.4 8.2C5.2 8.1 4.9 8.2 4.8 8.4L2.8 11.6C2.7 11.8 2.7 12.1 2.9 12.3L5 14C4.9 14.3 4.9 14.7 5 15L2.9 16.7C2.7 16.9 2.7 17.2 2.8 17.4L4.8 20.6C4.9 20.8 5.2 20.9 5.4 20.8L7.8 19.8C8.3 20.2 8.8 20.5 9.4 20.7L9.8 23.3C9.8 23.5 10 23.7 10.2 23.7H14.2C14.4 23.7 14.6 23.5 14.6 23.3L15 20.7C15.6 20.5 16.1 20.2 16.6 19.8L19 20.8C19.2 20.9 19.5 20.8 19.6 20.6L21.6 17.4C21.7 17.2 21.7 16.9 21.5 16.7L19.4 15Z" fill="#60a5fa" opacity="0.6"/>
                </svg>
                Dostępne Głosy
            </h2>
            <div class="voice-grid">
                <div class="voice-card">
                    <div class="voice-name">Zosia</div>
                    <div class="voice-type">Kobieta</div>
                </div>
                <div class="voice-card">
                    <div class="voice-name">Agatka</div>
                    <div class="voice-type">Kobieta</div>
                </div>
                <div class="voice-card">
                    <div class="voice-name">Danota</div>
                    <div class="voice-type">Kobieta</div>
                </div>
                <div class="voice-card">
                    <div class="voice-name">Krzysztof</div>
                    <div class="voice-type">Mężczyzna</div>
                </div>
                <div class="voice-card">
                    <div class="voice-name">Wojciech</div>
                    <div class="voice-type">Mężczyzna</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3.9 12C3.9 10.29 5.29 8.9 7 8.9H11V7H7C4.24 7 2 9.24 2 12C2 14.76 4.24 17 7 17H11V15.1H7C5.29 15.1 3.9 13.71 3.9 12Z" fill="#60a5fa"/>
                    <path d="M8 13H16V11H8V13Z" fill="#60a5fa"/>
                    <path d="M17 7H13V8.9H17C18.71 8.9 20.1 10.29 20.1 12C20.1 13.71 18.71 15.1 17 15.1H13V17H17C19.76 17 22 14.76 22 12C22 9.24 19.76 7 17 7Z" fill="#60a5fa"/>
                </svg>
                Parametry URL
            </h2>
            
            <h3><code>channel</code> (wymagane)</h3>
            <p>Nazwa Twojego kanału Kick.com</p>

            <h3><code>voice</code> (opcjonalne)</h3>
            <p>Nazwa głosu: Zosia, Agatka, Danota, Krzysztof, Wojciech</p>
            <p>Domyślnie: Zosia</p>

            <h3><code>volume</code> (opcjonalne)</h3>
            <p>Poziom głośności od 0 do 100</p>
            <p>Domyślnie: 50</p>

            <h3>Parametry Uprawnień:</h3>
            <ul>
                <li><code>anyone=on</code> - Pozwól wszystkim</li>
                <li><code>follower=on</code> - Pozwól obserwującym</li>
                <li><code>moderator=on</code> - Pozwól moderatorom (domyślnie włączone)</li>
                <li><code>og=on</code> - Pozwól posiadaczom odznaki OG</li>
                <li><code>subscriber=on</code> - Pozwól subskrybentom</li>
                <li><code>vip=on</code> - Pozwól VIP-om</li>
            </ul>

            <h3><code>pretext</code> (opcjonalne)</h3>
            <p>Wymagaj "tts" na początku wiadomości</p>
            <p>Wartości: on / off (Domyślnie: off)</p>
        </div>

        <div class="section">
            <h2>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#60a5fa"/>
                    <path d="M2 17L12 22L22 17V12L12 17L2 12V17Z" fill="#60a5fa" opacity="0.6"/>
                </svg>
                Jak Używać
            </h2>
            <ul>
                <li>Wygeneruj swój link TTS używając generatora powyżej</li>
                <li>Dodaj go jako Browser Source w OBS/Streamlabs</li>
                <li>Ustaw wymiary na 800x600 (rozmiar nie ma znaczenia, będzie niewidoczne)</li>
                <li>Zacznij streamować</li>
                <li>Autoryzowani użytkownicy mogą teraz wysyłać wiadomości, które będą czytane na głos</li>
            </ul>
        </div>
    </div>

    <script>
        function toggleCheckbox(checkbox) {
            const parent = checkbox.parentElement;
            if (checkbox.checked) {
                parent.classList.add('checked');
            } else {
                parent.classList.remove('checked');
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const hasChannel = urlParams.has('channel');

        if (hasChannel) {
            document.getElementById('readme').style.display = 'none';
            document.body.style.background = 'transparent';
            initTTS();
        }

        function generateURL() {
            const channel = document.getElementById('channel').value.trim();
            const voice = document.getElementById('voice').value;
            const volume = document.getElementById('volume').value;
            
            const anyone = document.getElementById('anyone').checked;
            const follower = document.getElementById('follower').checked;
            const moderator = document.getElementById('moderator').checked;
            const og = document.getElementById('og').checked;
            const subscriber = document.getElementById('subscriber').checked;
            const vip = document.getElementById('vip').checked;
            const pretext = document.getElementById('pretext').checked;

            if (!channel) {
                alert('Proszę podać nazwę kanału!');
                return;
            }

            const baseUrl = window.location.origin + window.location.pathname;
            let url = baseUrl + '?channel=' + encodeURIComponent(channel);
            
            if (voice !== 'Zosia') url += '&voice=' + voice;
            if (volume !== '50') url += '&volume=' + volume;
            if (anyone) url += '&anyone=on';
            if (follower) url += '&follower=on';
            if (moderator) url += '&moderator=on';
            if (og) url += '&og=on';
            if (subscriber) url += '&subscriber=on';
            if (vip) url += '&vip=on';
            if (pretext) url += '&pretext=on';

            document.getElementById('url-display').textContent = url;
            document.getElementById('result').classList.add('show');
        }

        function copyURL() {
            const urlText = document.getElementById('url-display').textContent;
            navigator.clipboard.writeText(urlText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✓ Skopiowano!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        function initTTS() {
            const kick = urlParams.get('channel') || 'igor_ovh';
            
            const voices = {
                'Agatka': { EID: '4', LID: '14', VID: '1' },
                'Danota': { EID: '7', LID: '14', VID: '1' },
                'Krzysztof': { EID: '2', LID: '14', VID: '2' },
                'Wojciech': { EID: '7', LID: '14', VID: '2' },
                'Zosia': { EID: '2', LID: '14', VID: '1' }
            };

            const voiceName = urlParams.get('voice') || 'Zosia';
            const selectedVoice = voices[voiceName] || voices['Zosia'];
            const ttsVoiceEID = selectedVoice.EID;
            const ttsVoiceLID = selectedVoice.LID;
            const ttsVoiceVID = selectedVoice.VID;
            
            const volume = parseInt(urlParams.get('volume')) || 50;
            const anyone = urlParams.get('anyone') === 'on';
            const follower = urlParams.get('follower') === 'on';
            const moderator = urlParams.get('moderator') === 'on';
            const og = urlParams.get('og') === 'on';
            const subscriber = urlParams.get('subscriber') === 'on';
            const vip = urlParams.get('vip') === 'on';
            const pretext = urlParams.get('pretext') === 'on';

            console.log('TTS Config:', { kick, voiceName, volume, anyone, follower, moderator, og, subscriber, vip, pretext });

            const badgesConfig = {
                'moderator': moderator,
                'vip': vip,
                'og': og,
                'subscriber': subscriber,
                'broadcaster': true
            };

            const excludedKickBots = [
                'kickbot', 'botrix', 'mrbeefbot', 'intrx', 'livebot',
                'logibot', 'lottobot', 'squadbot', 'notibot', 'percent',
                'casterlabs', 'ayybabz', 'babblechat'
            ];

            const chat = new WebSocket('wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=7.6.0&flash=false');
            let isPlaying = false;
            let audio = null;

            function hasBroadcasterBadge(badges) {
                return badges && badges.some(badge => badge.type === 'broadcaster');
            }

            async function fetchUserData(username) {
                const response = await fetch('https://kick.com/api/v2/channels/' + username);
                return await response.json();
            }

            async function isFollowedChannel(channelName, username) {
                if (!follower) return true;
                const url = 'https://kick.com/api/v2/channels/' + channelName + '/users/' + username;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    return data.following_since !== null;
                } catch (error) {
                    console.error('Follower check error:', error);
                    return false;
                }
            }

            async function playTTS(text, volumeLevel) {
                const cleanText = text.replace(/%/g, 'percent');
                const ttsUrl = 'https://cache-a.oddcast.com/tts/genC.php?EID=' + ttsVoiceEID + '&LID=' + ttsVoiceLID + '&VID=' + ttsVoiceVID + '&TXT=' + encodeURIComponent(cleanText);

                console.log('Playing TTS:', cleanText);

                try {
                    if (isPlaying) {
                        console.log('TTS is playing, waiting...');
                        await new Promise(resolve => {
                            const interval = setInterval(() => {
                                if (!isPlaying) {
                                    clearInterval(interval);
                                    resolve();
                                }
                            }, 500);
                        });
                    }

                    isPlaying = true;
                    audio = new Audio(ttsUrl);
                    audio.volume = volumeLevel / 100;
                    
                    audio.addEventListener('ended', function() {
                        isPlaying = false;
                        console.log('TTS ended');
                    });

                    audio.addEventListener('error', function(e) {
                        console.error('Audio error:', e);
                        isPlaying = false;
                    });

                    await audio.play();
                    console.log('TTS playing');
                } catch (error) {
                    console.error('TTS error:', error);
                    isPlaying = false;
                }
            }

            function checkSenderBadges(badges, config, anyoneMode) {
                if (anyoneMode) return true;
                
                if (badges) {
                    const enabledBadges = Object.keys(config).filter(key => config[key]);
                    const senderBadges = badges.map(badge => badge.type);
                    const hasPermission = senderBadges.some(badge => enabledBadges.includes(badge));
                    
                    if (hasPermission) {
                        console.log('User has badges:', senderBadges.join(', '));
                    }
                    
                    return hasPermission;
                }
                return false;
            }

            chat.addEventListener('open', async () => {
                console.log('Connecting to Kick...');
                const userData = await fetchUserData(kick);
                chat.send(JSON.stringify({
                    'event': 'pusher:subscribe',
                    'data': {
                        'auth': '',
                        'channel': 'chatrooms.' + userData.chatroom.id + '.v2'
                    }
                }));
                console.log('Connected to Kick - ' + kick);
            });

            chat.addEventListener('message', async messageEvent => {
                let parsedMessage = JSON.parse(messageEvent.data);

                if (parsedMessage.event !== 'App\\Events\\ChatMessageEvent') {
                    return;
                }

                let messageData = JSON.parse(parsedMessage.data);
                let content = messageData.content;
                let sender = messageData.sender;
                let username = sender.username;
                let identity = sender.identity;
                let badges = identity.badges;

                const isBroadcaster = hasBroadcasterBadge(badges);
                const isFollower = await isFollowedChannel(kick, username);

                if (follower && !isFollower && !isBroadcaster) {
                    console.log('User ' + username + ' is not a follower');
                    return;
                }

                if (isBroadcaster && content.toLowerCase().trim() === '!skiptts') {
                    console.log('Broadcaster skipped TTS');
                    if (audio) {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                    isPlaying = false;
                    return;
                }

                const cleanContent = content.replace(/\b(?:https?|ftp|file):\/\/\S+/gi, 'LINK');

                if (content.startsWith('!')) {
                    return;
                }

                if (excludedKickBots.includes(username.toLowerCase())) {
                    return;
                }

                if (checkSenderBadges(badges, badgesConfig, anyone)) {
                    let textToSpeak = cleanContent;
                    
                    if (pretext) {
                        if (!cleanContent.toLowerCase().startsWith('tts')) {
                            return;
                        }
                        textToSpeak = cleanContent.replace(/^tts\s?/i, '');
                    }
                    
                    textToSpeak = textToSpeak.trim();
                    textToSpeak = textToSpeak.replace(/\[emote:\d+:(\w+)\]/g, '$1');

                    if (textToSpeak.length > 0) {
                        await playTTS(textToSpeak, volume);
                    }
                } else {
                    console.log('User ' + username + ' has no permission');
                }
            });

            chat.addEventListener('error', (error) => {
                console.error('WebSocket error:', error);
            });

            chat.addEventListener('close', () => {
                console.log('WebSocket closed, reconnecting...');
                setTimeout(() => initTTS(), 5000);
            });
        }
    </script>
</body>
</html>
